# Техническое задание: установка, подключение к Discord и обновление бота Zavod

## 1. Общие положения
- **Объект**: Discord-бот Zavod для расчёта стоимости крафта в игре EVE Echoes.
- **Цель документа**: формализовать требования и последовательность действий по установке, подключению к инфраструктуре Discord и обновлению бота на рабочем сервере.
- **Ответственные**: системный администратор проекта (исполнитель), владелец продукта (заказчик).

## 2. Требования к окружению
- Сервер под управлением Linux (рекомендуется Ubuntu 22.04 LTS) с доступом в интернет и установленным `git`.
- Python версии 3.11 или выше; наличие инструментов `python3-venv` и `pip`.
- Учетная запись Discord с правами на создание и управление приложениями в [портале разработчика Discord](https://discord.com/developers/applications).
- При использовании функции автоматического обновления `/update_bot` — доступ к приватному репозиторию GitHub (при необходимости) и настроенный персональный токен доступа.

## 3. Подготовительные действия
1. Создать на сервере отдельного системного пользователя (например, `zavod`) без привилегий `sudo`, если иное не оговорено.
2. Определить директорию установки (по умолчанию `/opt/zavod`).
3. Получить от владельца продукта параметры доступа:
   - Discord Bot Token.
   - (Опционально) `GITHUB_USERNAME` и `GITHUB_TOKEN` для приватного репозитория.
   - Желаемые параметры логирования и путь к файлу базы данных.

## 4. Процедура установки
### 4.1 Установка через скрипт `install.sh`
1. Скачать или склонировать репозиторий `Zavod` на сервер: `git clone <repo_url> /opt/zavod`.
2. Перейти в каталог проекта и выполнить `bash install.sh`.
3. На запросы скрипта указать:
   - Директорию установки и путь для virtualenv.
   - Discord токен.
   - (Опционально) данные для доступа к GitHub и настройки systemd-сервиса.
4. Проверить успешность завершения скрипта, наличие файла `.env` и созданного виртуального окружения `.venv`.

### 4.2 Ручная установка (если скрипт не используется)
1. В каталоге проекта создать виртуальное окружение: `python -m venv .venv`.
2. Активировать окружение и установить зависимости: `source .venv/bin/activate`, `pip install -r requirements.txt`.
3. Создать файл `.env` или экспортировать переменные окружения:
   - `DISCORD_TOKEN=...`
   - `DATABASE_PATH=...` (при необходимости вынести базу за пределы каталога проекта).
   - `LOG_FILE`, `LOG_LEVEL` при необходимости журналирования.
   - Переменные для обновления: `GITHUB_USERNAME`, `GITHUB_TOKEN`, `BOT_RESTART_COMMAND`, `BOT_AUTO_RESTART`, `BOT_AUTO_RESTART_DELAY`.
4. Убедиться, что база данных `zavod.db` доступна и имеет права записи для пользователя, под которым будет запускаться бот (создаётся автоматически при первом запуске).

## 5. Подключение к Discord
1. В портале разработчика Discord создать новое приложение и добавить к нему бота.
2. Скопировать токен бота и передать его исполнителю для внесения в `.env`.
3. На вкладке "OAuth2" сформировать URL с правами `bot` и `applications.commands`, предоставив минимально необходимые права (например, `Send Messages`, `Use Slash Commands`).
4. Перейти по URL и добавить бота на целевой Discord-сервер.
5. Проверить, что бот отображается в списке участников сервера и имеет доступ к каналам, где требуется взаимодействие.
6. Выполнить тестовый запуск `python bot.py` и убедиться, что бот успешно авторизуется (в логах должно появиться сообщение о старте и регистрации слэш-команд).

## 6. Настройка обновления бота
1. Убедиться, что репозиторий настроен на нужную ветку (`main` или указанную заказчиком).
2. Проверить наличие прав на выполнение `git pull` (актуально для приватных репозиториев — могут потребоваться сохранённые учётные данные или токен).
3. Настроить переменные окружения для автоматического перезапуска:
   - `BOT_RESTART_COMMAND` — команда для перезапуска сервиса (например, `systemctl restart zavod-bot`).
   - `BOT_AUTO_RESTART=1` и (опционально) `BOT_AUTO_RESTART_DELAY` для сценария, когда перезапуск обрабатывается менеджером процессов (systemd, supervisor).
4. При использовании systemd создать сервисный файл, который запускает бот из виртуального окружения и автоматически перезапускает при выходе.
5. Протестировать команду `/update_bot` в Discord-канале с правами администратора:
   - Бот должен выполнить `git pull`, вывести результат в канал и инициировать перезапуск согласно настройкам.
   - В логах после перезапуска должно фиксироваться повторное подключение к Discord.

## 7. Контроль и приёмка
- Скрипт установки завершается без ошибок, виртуальное окружение и зависимости установлены.
- Бот успешно запускается, подключается к Discord и отвечает на тестовую команду (например, `/global_efficiency`).
- Команда `/update_bot` выполняется без ошибок, изменения подтягиваются из репозитория, перезапуск срабатывает в соответствии с конфигурацией.
- Логи (`LOG_FILE`, журнал systemd) не содержат критических ошибок в течение 24 часов после запуска.

## 8. Документация и поддержка
- Хранить актуальную версию `.env` и сервисного файла systemd в защищённом хранилище.
- Обновлять данный документ при изменении требований к окружению, процессу установки или механизму обновления.
- При передаче проекта новому администратору предоставить ссылку на репозиторий, данный ТЗ и доступы к инфраструктуре.
