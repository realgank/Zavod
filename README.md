# Zavod Discord Bot

Бот для расчёта стоимости крафта в игре **EVE Echoes**. Данные рецептов и цен
хранятся в SQLite базе `zavod.db`.

## Требования

- Python 3.11+
- Discord токен (создаётся в [портале разработчика Discord](https://discord.com/developers/applications))

## Установка

### Вариант 1. Скрипт установки (Ubuntu)

На Ubuntu можно воспользоваться автоматическим скриптом `install.sh`. Он установит
необходимые зависимости, создаст виртуальное окружение, запросит Discord токен и,
при необходимости, параметры доступа к приватному GitHub репозиторию для команды
`/update_bot`.

```bash
bash install.sh
```

Скрипт предложит указать директорию установки и, при желании, настроит systemd
сервис для автозапуска бота.

### Вариант 2. Ручная установка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

Создайте файл базы данных (бот сделает это автоматически при первом запуске)
и установите переменные окружения:

```bash
export DISCORD_TOKEN=ВАШ_ТОКЕН
# Для приватного репозитория GitHub (опционально):
export GITHUB_USERNAME=ВАШ_ЛОГИН
export GITHUB_TOKEN=ВАШ_PERSONAL_ACCESS_TOKEN
```

## Запуск

Бот автоматически читает переменные окружения из файла `.env` в корне проекта,
если он существует. Это упрощает запуск после выполнения `install.sh`, который
создаёт такой файл.

```bash
python bot.py
```

## Команды

- `/add_recipe <название> [выход_количество]` – добавить или обновить рецепт.
  Таблицу компонентов (пример ниже) можно вставить в поле команды или прикрепить
  текстовый файл.
- `/price <название> [эффективность]` – рассчитать стоимость рецепта. Если
  эффективность не указана, берётся глобальное значение.
- `/resource_price <название>` – показать последнюю сохранённую цену ресурса.
- `/set_efficiency <значение>` – установить глобальную эффективность (требуются
  права администратора).
- `/global_efficiency` – показать текущую глобальную эффективность.
- `/update_bot` – обновить код бота из GitHub репозитория (требуются права
  администратора). После успешного обновления бот может автоматически
  перезапуститься, если настроены переменные окружения (см. ниже).

### Формат рецепта

```
ID    Название         Количество    Оценка стоимости
1     Sheen Compound   14764         6269680.24
...
```

Стоимость ресурса рассчитывается как `Оценка стоимости / Количество` и
сохраняется глобально. Если для ресурса существует другой рецепт, его стоимость
будет вычислена из составных компонентов.

### Эффективность

Эффективность всегда добавляется как 100 %. При расчёте цены можно указать
другое значение – количество компонентов будет скорректировано по формуле
`Количество * (100 / эффективность)`.

## Обновление и перезапуск

Команда `/update_bot` выполняет `git pull` и, при необходимости, перезапускает
бота:

- Если задать переменную окружения `BOT_RESTART_COMMAND`, бот выполнит указанную
  команду (например, `systemctl restart zavod-bot`).
- Если установить переменную `BOT_AUTO_RESTART=1`, то после обновления процесс
  завершится с небольшим ожиданием (управляется переменной
  `BOT_AUTO_RESTART_DELAY`, значение по умолчанию – 5 секунд). Для сервисов
  systemd это приведёт к автоматическому перезапуску согласно настройкам
  `Restart`.
- Если переменные не заданы, бот сообщит, что перезапуск требуется выполнить
  вручную.
