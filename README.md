# Zavod Discord Bot

Бот для расчёта стоимости крафта в игре **EVE Echoes**. Данные рецептов и цен
хранятся в SQLite базе `zavod.db`.

## Требования

- Python 3.11+
- Discord токен (создаётся в [портале разработчика Discord](https://discord.com/developers/applications))

## Установка

### Вариант 1. Скрипт установки (Ubuntu)

На Ubuntu можно воспользоваться автоматическим скриптом `install.sh`. Он установит
необходимые зависимости, создаст виртуальное окружение, запросит Discord токен и,
при необходимости, параметры доступа к приватному GitHub репозиторию для команды
`/update_bot`.

```bash
bash install.sh
```

Скрипт предложит указать директорию установки и, при желании, настроит systemd
сервис для автозапуска бота.

### Вариант 2. Ручная установка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

Создайте файл базы данных (бот сделает это автоматически при первом запуске)
и установите переменные окружения:

```bash
export DISCORD_TOKEN=ВАШ_ТОКЕН
# Для приватного репозитория GitHub (опционально):
export GITHUB_USERNAME=ВАШ_ЛОГИН
export GITHUB_TOKEN=ВАШ_PERSONAL_ACCESS_TOKEN
# Путь к базе данных (опционально, позволяет использовать общую базу для нескольких серверов)
export DATABASE_PATH=/srv/zavod/zavod.db
```

## Запуск

Бот автоматически читает переменные окружения из файла `.env` в корне проекта,
если он существует. Это упрощает запуск после выполнения `install.sh`, который
создаёт такой файл.

```bash
python bot.py
```

## Команды

- `/add_recipe <название> <тип> [выход_количество]` – добавить или обновить рецепт.
  Таблицу компонентов (пример ниже) можно вставить в поле команды или прикрепить
  текстовый файл. Тип корабля обязателен и используется для расчёта эффективности.
- `/price <название> [эффективность]` – рассчитать стоимость рецепта. Если
  эффективность не указана, берётся глобальное значение.
- `/resource_price <название>` – показать последнюю сохранённую цену ресурса.
- `/set_efficiency <значение>` – установить глобальную эффективность (требуются
  права администратора).
- `/set_ship_type_efficiency <тип> <значение>` – установить эффективность для
  конкретного типа корабля (права администратора).
- `/delete_ship_type_efficiency <тип>` – удалить настройку эффективности для
  выбранного типа корабля (права администратора).
- `/ship_type_efficiencies` – показать текущие значения эффективности по типам
  кораблей и статистику рецептов.
- `/set_settings_console_channel <канал>` – назначить канал, в котором будет
  опубликована консоль управления эффективностью (права администратора).
- `/refresh_settings_console` – вручную обновить сообщение консоли настроек.
- `/audit_recipe_types` – вывести список рецептов, у которых не указан тип.
- `/global_efficiency` – показать текущую глобальную эффективность.
- `/update_bot` – обновить код бота из GitHub репозитория (требуются права
  администратора). После успешного обновления бот может автоматически
  перезапуститься, если настроены переменные окружения (см. ниже).

### Формат рецепта

```
ID    Название         Количество    Оценка стоимости
1     Sheen Compound   14764         6269680.24
...
```

Стоимость ресурса рассчитывается как `Оценка стоимости / Количество` и
сохраняется глобально. Если для ресурса существует другой рецепт, его стоимость
будет вычислена из составных компонентов.

### Эффективность

Эффективность всегда добавляется как 100 %. При расчёте цены можно указать
другое значение – количество компонентов будет скорректировано по формуле
`Количество * (100 / эффективность)`. Если для рецепта задан тип корабля и
для этого типа настроена собственная эффективность, при расчёте она будет
использована автоматически. Управлять глобальной и типовой эффективностью можно
через команды или консоль настроек, публикуемую в выделенном канале.

## Обновление и перезапуск

Команда `/update_bot` выполняет `git pull` и, при необходимости, перезапускает
бота:

- Если задать переменную окружения `BOT_RESTART_COMMAND`, бот выполнит указанную
  команду (например, `systemctl restart zavod-bot`).
- Если установить переменную `BOT_AUTO_RESTART=1`, то после обновления процесс
  завершится с небольшим ожиданием (управляется переменной
  `BOT_AUTO_RESTART_DELAY`, значение по умолчанию – 5 секунд). Для сервисов
  systemd это приведёт к автоматическому перезапуску согласно настройкам
  `Restart`.
- Если переменные не заданы, бот сообщит, что перезапуск требуется выполнить
  вручную.
